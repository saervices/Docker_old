---
services:
  seafile_seasearch:
    ######################################################################
    # --- CONTAINER BASICS
    ######################################################################
    image: ${SEAFILE_SEASEARCH_IMAGE:?Image required}
    container_name: ${APP_NAME:?App name required}-seasearch
    hostname: ${APP_NAME}-seasearch
    restart: unless-stopped                                                                                                                                     # Automatically restart unless manually stopped

    ######################################################################
    # --- SECURITY SETTINGS
    ######################################################################
    cap_drop:                                                                                                                                                   # Drop all capabilities by default
      - ALL
    cap_add:                                                                                                                                                    # Add only the minimum required capabilities
      - SETUID                                                                                                                                                  # Required: image switches user internally
      - SETGID                                                                                                                                                  # Required: group management
      - CHOWN                                                                                                                                                   # Required: file ownership on data volume
    security_opt:
      - no-new-privileges:true                                                                                                                                  # Prevent privilege escalation
      - apparmor=${APPARMOR_PROFILE:-docker-default}                                                                                                            # Require AppArmor confinement on compatible hosts

    ######################################################################
    # --- SYSTEM RUNTIME
    ######################################################################
    init: true                                                                                                                                                  # PID 1 is tini – handles zombies properly
    stop_grace_period: 30s                                                                                                                                      # Give app time to shut down gracefully
    oom_score_adj: -500                                                                                                                                         # Reduce likelihood of getting killed under memory pressure
    tmpfs:                                                                                                                                                      # Ephemeral storage in RAM, auto-cleared on restart
      - /run                                                                                                                                                    # Runtime files (PID files, sockets, etc.)
      - /tmp                                                                                                                                                    # Short-lived temp files; faster and auto-cleared on restart

    ######################################################################
    # --- FILESYSTEM & SECRETS
    ######################################################################
    volumes:                                                                                                                                                    # Mount external storage or host directories into the container for persistent data or config
      - /etc/localtime:/etc/localtime:ro                                                                                                                        # Set container time to host time
      - /etc/timezone:/etc/timezone:ro                                                                                                                          # Pass timezone info
      - seasearch_data:/opt/seasearch/data:rw                                                                                                                   # Persistent search index data
    secrets:
      - SEAFILE_SEASEARCH_ADMIN_PASSWORD

    ######################################################################
    # --- NETWORKING / REVERSE PROXY
    ######################################################################
    networks:                                                                                                                                                   # Define which Docker networks the container connects to (controls communication and isolation)
      - backend                                                                                                                                                 # Internal only: Seafile connects to SeaSearch API on port 4080

    ######################################################################
    # --- RUNTIME / ENVIRONMENT
    ######################################################################
    entrypoint:                                                                                                                                                 # Read admin password from Docker secret and exec the search engine binary
      - /bin/sh
      - -c
      - |
          export SS_FIRST_ADMIN_USER=seasearch; \
                 SS_FIRST_ADMIN_PASSWORD="$$(cat /run/secrets/SEAFILE_SEASEARCH_ADMIN_PASSWORD)"; \
          exec /go/bin/zincsearch
    environment:                                                                                                                                                # Environment variables for container configuration
      SS_LOG_TO_STDOUT: ${SEAFILE_LOG_TO_STDOUT:-true}                                                                                                          # Send logs to stdout for docker logs
      SS_LOG_LEVEL: ${SEAFILE_SEASEARCH_LOG_LEVEL:-info}                                                                                                        # Log level (debug, info, warn, error)
      SS_MAX_OBJ_CACHE_SIZE: ${SEAFILE_SEASEARCH_MAX_OBJ_CACHE_SIZE:-10GB}                                                                                      # Max object cache size for search index
    logging:                                                                                                                                                    # Configure log driver and limits to control log size and rotation
      driver: "json-file"
      options:
        max-size: "10m"                                                                                                                                         # Max log file size before rotation
        max-file: "3"                                                                                                                                           # Keep up to 3 rotated log files
    healthcheck:                                                                                                                                                # Periodic container health check to ensure service availability
      test: ['CMD-SHELL', 'nc -z localhost 4080 || exit 1']                                                                                                     # TCP port check for SeaSearch API
      interval: 30s                                                                                                                                             # Time between checks
      timeout: 5s                                                                                                                                               # Time to wait for response
      retries: 3                                                                                                                                                # Number of retries before marking unhealthy
      start_period: 30s                                                                                                                                         # Give SeaSearch time to initialize
    stdin_open: false                                                                                                                                           # Optional: keep STDIN open
    tty: false                                                                                                                                                  # Disable terminal allocation; used for non-interactive containers

    ######################################################################
    # --- DEPENDENCIES
    ######################################################################
    # depends_on:                                                                                                                                               # No dependencies – SeaSearch runs standalone, Seafile connects to it
    #   app:
    #     condition: service_healthy

    ######################################################################
    # --- SYSTEM LIMITS
    ######################################################################
    # mem_limit: ${SS_MEM_LIMIT:-1g}                                                                                                                            # Memory ceiling (SeaSearch is lighter than Elasticsearch)
    # cpus: ${SS_CPU_LIMIT:-1.0}                                                                                                                                # Fractional CPU quota
    # pids_limit: ${SS_PIDS_LIMIT:-128}                                                                                                                         # Cap number of processes/threads

volumes:
  seasearch_data:
    driver: local

secrets:
  SEAFILE_SEASEARCH_ADMIN_PASSWORD:
    file: ${SEAFILE_SEASEARCH_ADMIN_PASSWORD_PATH:?Secret path required}${SEAFILE_SEASEARCH_ADMIN_PASSWORD_FILENAME:?Secret filename required}

networks:
  backend:
    external: true
